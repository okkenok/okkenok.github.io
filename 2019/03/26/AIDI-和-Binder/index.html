<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="一、概述Binder 可以提供系统中任何程序都可以访问的全局服务。Android Binder 框架分为服务器接口、Binder 驱动以及客户端接口  服务端接口：实际上是 Binder 类的对象，该对象一旦创建，内部则会启动一个隐藏线程，会接收 Binder 驱动发送的消息，收到消息后，会执行 Binder 对象中的onTransact()函数，并按照该函数的参数执行不同的服务端代码； Bind">
<meta name="keywords" content="Android 面试">
<meta property="og:type" content="article">
<meta property="og:title" content="AIDI 和 Binder">
<meta property="og:url" content="http://yoursite.com/2019/03/26/AIDI-和-Binder/index.html">
<meta property="og:site_name" content="Okkenok">
<meta property="og:description" content="一、概述Binder 可以提供系统中任何程序都可以访问的全局服务。Android Binder 框架分为服务器接口、Binder 驱动以及客户端接口  服务端接口：实际上是 Binder 类的对象，该对象一旦创建，内部则会启动一个隐藏线程，会接收 Binder 驱动发送的消息，收到消息后，会执行 Binder 对象中的onTransact()函数，并按照该函数的参数执行不同的服务端代码； Bind">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-30dce36be4e6617596b5fab96ef904c6_hd.jpg">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-aab2affe42958a659ea8a517ffaff5a0_hd.jpg">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-cbd7d2befbed12d4c8896f236df96dbf_hd.jpg">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-729b3444cd784d882215a24067893d0e_hd.jpg">
<meta property="og:updated_time" content="2019-03-26T14:30:26.798Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AIDI 和 Binder">
<meta name="twitter:description" content="一、概述Binder 可以提供系统中任何程序都可以访问的全局服务。Android Binder 框架分为服务器接口、Binder 驱动以及客户端接口  服务端接口：实际上是 Binder 类的对象，该对象一旦创建，内部则会启动一个隐藏线程，会接收 Binder 驱动发送的消息，收到消息后，会执行 Binder 对象中的onTransact()函数，并按照该函数的参数执行不同的服务端代码； Bind">
<meta name="twitter:image" content="https://pic3.zhimg.com/80/v2-30dce36be4e6617596b5fab96ef904c6_hd.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>AIDI 和 Binder</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/27/ANR/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/26/Window、Activity、DecorView以及ViewRoot的关系/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/26/AIDI-和-Binder/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&text=AIDI 和 Binder"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&is_video=false&description=AIDI 和 Binder"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AIDI 和 Binder&body=Check out this article: http://yoursite.com/2019/03/26/AIDI-和-Binder/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&name=AIDI 和 Binder&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、概述"><span class="toc-number">1.</span> <span class="toc-text">一、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、AIDL-的使用"><span class="toc-number">2.</span> <span class="toc-text">二、AIDL 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务端"><span class="toc-number">2.1.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端"><span class="toc-number">2.2.</span> <span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析-AIDL-生成的代码"><span class="toc-number">2.3.</span> <span class="toc-text">分析 AIDL 生成的代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Binder-原理剖析"><span class="toc-number">3.</span> <span class="toc-text">Binder 原理剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么必须理解-Binder-？"><span class="toc-number">3.1.</span> <span class="toc-text">为什么必须理解 Binder ？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么是-Binder"><span class="toc-number">3.2.</span> <span class="toc-text">为什么是 Binder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-下传统的进程间通信原理"><span class="toc-number">3.3.</span> <span class="toc-text">Linux 下传统的进程间通信原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binder-跨进程通信原理"><span class="toc-number">3.4.</span> <span class="toc-text">Binder 跨进程通信原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#动态内核可加载模块-amp-amp-内存映射"><span class="toc-number">3.4.1.</span> <span class="toc-text">动态内核可加载模块 &amp;&amp; 内存映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binder-IPC-实现原理"><span class="toc-number">3.4.2.</span> <span class="toc-text">Binder IPC 实现原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binder-通信模型"><span class="toc-number">3.5.</span> <span class="toc-text">Binder 通信模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Client-Server-ServiceManager-驱动"><span class="toc-number">3.5.1.</span> <span class="toc-text">Client/Server/ServiceManager/驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binder-通信过程"><span class="toc-number">3.5.2.</span> <span class="toc-text">Binder 通信过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binder-通信中的代理模式"><span class="toc-number">3.5.3.</span> <span class="toc-text">Binder 通信中的代理模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考引用"><span class="toc-number">4.</span> <span class="toc-text">参考引用</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        AIDI 和 Binder
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Okkenok</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-03-26T14:28:59.000Z" itemprop="datePublished">2019-03-26</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Android-面试/">Android 面试</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>Binder 可以提供系统中任何程序都可以访问的全局服务。Android Binder 框架分为服务器接口、Binder 驱动以及客户端接口</p>
<ol>
<li>服务端接口：实际上是 Binder 类的对象，该对象一旦创建，内部则会启动一个隐藏线程，会接收 Binder 驱动发送的消息，收到消息后，会执行 Binder 对象中的<code>onTransact()</code>函数，并按照该函数的参数执行不同的服务端代码；</li>
<li>Binder 驱动：该对象也为 Binder 类的实例，客户端通过该对象访问远程服务。</li>
<li>客户端接口：获得 Binder 驱动，调用其<code>transact()</code>发送消息至服务器</li>
</ol>
<h1 id="二、AIDL-的使用"><a href="#二、AIDL-的使用" class="headerlink" title="二、AIDL 的使用"></a>二、AIDL 的使用</h1><p>创建 aidl 文件；创建一个 Service；利用 XxxAIDL.Stub 通过<code>onBind()</code>返回 Binder 给客户端，暴露接口；客户端通过 ServiceConnection 与之交互。</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>创建一个包名：com.demo.aidl，在包内创建一个 ICalcAIDL.aidl 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.aidl.calc</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICalcAIDL</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.hg_binder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.demo.aidl.ICalcAIDL;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalcService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"server"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent t)</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onRebind(intent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ICalcAIDL.Stub mBinder = <span class="keyword">new</span> ICalcAIDL.Stub()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x + y;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x - y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再在 AndroidManifest 中注册</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">"com.demo.hg_binder.CalcService"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.demo.aidl.calc"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ICalcAIDL mCalcAidl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ServiceConnection mServiceConn = <span class="keyword">new</span> ServiceConnection()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span></span>&#123;</span><br><span class="line">            mCalcAidl = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span></span>&#123;</span><br><span class="line">            mCalcAidl = ICalcAIDL.Stub.asInterface(service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        intent.setAction(<span class="string">"com.demo.aidl.calc"</span>);</span><br><span class="line">        bindService(intent, mServiceConn, Context.BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbindService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        unbindService(mServiceConn);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInvoked</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mCalcAidl != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> addRes = mCalcAidl.add(<span class="number">12</span>, <span class="number">12</span>);</span><br><span class="line">            ...</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 服务器被异常杀死，请重新绑定服务端</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">minInvoked</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mCalcAidl != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> minRes = mCalcAidl.min(<span class="number">58</span>, <span class="number">12</span>);</span><br><span class="line">            ...</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 服务器被异常杀死，请重新绑定服务端</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析-AIDL-生成的代码"><a href="#分析-AIDL-生成的代码" class="headerlink" title="分析 AIDL 生成的代码"></a>分析 AIDL 生成的代码</h2><p>Stub 类 <code>onTransact()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="title">implement</span> <span class="title">com</span>.<span class="title">demo</span>.<span class="title">aldl</span>.<span class="title">calc</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(code)&#123;</span><br><span class="line">            <span class="keyword">case</span> INTERFACE_TRANSACTION:&#123;</span><br><span class="line">                reply.writeString(DESCRIPTOR);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> TRANSACTION_add:&#123;</span><br><span class="line">                data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                <span class="keyword">int</span> _arg0;</span><br><span class="line">                _arg0 = data.readInt();</span><br><span class="line">                <span class="keyword">int</span> _arg1;</span><br><span class="line">                _arg1 = data.readInt();</span><br><span class="line">                <span class="keyword">int</span> _result = <span class="keyword">this</span>.add(_arg0, _arg1);</span><br><span class="line">                reply.writeNoException();</span><br><span class="line">                reply.writeInt(_result);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> TRANSACTION_min:&#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>code 是一个整型的唯一标识，用于区分执行哪个方法，客户端会传递此参数，告诉服务端执行哪个方法；data 是客户端传递过来的参数；reply 是服务端返回给客户端的值；flags 标明是否有返回值，0 为有（双向），1 为没有（单向）</p>
<h1 id="Binder-原理剖析"><a href="#Binder-原理剖析" class="headerlink" title="Binder 原理剖析"></a>Binder 原理剖析</h1><h2 id="为什么必须理解-Binder-？"><a href="#为什么必须理解-Binder-？" class="headerlink" title="为什么必须理解 Binder ？"></a>为什么必须理解 Binder ？</h2><ul>
<li>为什么 Activity 间传递对象需要序列化？</li>
<li>Activity 的启动流程是什么样的？</li>
<li>四大组件底层的通信机制是怎样的？</li>
<li>AIDL 内部的实现原理是什么？</li>
<li>插件化编程技术应该从何学起？……</li>
</ul>
<h2 id="为什么是-Binder"><a href="#为什么是-Binder" class="headerlink" title="为什么是 Binder"></a>为什么是 Binder</h2><p>性能、稳定性和安全性</p>
<p><img src="https://pic3.zhimg.com/80/v2-30dce36be4e6617596b5fab96ef904c6_hd.jpg" alt="Binder 优势"></p>
<h2 id="Linux-下传统的进程间通信原理"><a href="#Linux-下传统的进程间通信原理" class="headerlink" title="Linux 下传统的进程间通信原理"></a>Linux 下传统的进程间通信原理</h2><ul>
<li>进程隔离：内存是不共享的</li>
<li>进程空间划分：用户空间（User Space）、内核空间（Kernel Space）。它们之间是隔离的</li>
<li>系统调用：用户态与内核态</li>
</ul>
<p>通常的做法是将消息发送方将要发送的数据存放在内存缓存区中，通过系统调用进入内核态。然后内核程序在内核空间分配内存，开辟一块内核缓存区，调用<code>copyfromuser()</code>将数据从用户空间的内存缓存区拷贝到内核空间的内核缓存区中。同样，接收方进程在接收数据时在自己的用户空间开辟一块内存缓存区，然后内核程序调用<code>copytouser()</code>将数据从内核缓存区拷贝到接收进程的内存缓存区。这样数据发送方进程和数据接收方进程就完成了一次数据传输，我们称完成了一次进程间的通信。</p>
<p><img src="https://pic1.zhimg.com/80/v2-aab2affe42958a659ea8a517ffaff5a0_hd.jpg" alt="传统 IPC 通信原理"></p>
<p>存在两个问题：</p>
<ol>
<li>性能低下</li>
<li>接收数据的缓存区大小无法知道，只能尽可能大，浪费空间或是时间。</li>
</ol>
<h2 id="Binder-跨进程通信原理"><a href="#Binder-跨进程通信原理" class="headerlink" title="Binder 跨进程通信原理"></a>Binder 跨进程通信原理</h2><h3 id="动态内核可加载模块-amp-amp-内存映射"><a href="#动态内核可加载模块-amp-amp-内存映射" class="headerlink" title="动态内核可加载模块 &amp;&amp; 内存映射"></a>动态内核可加载模块 &amp;&amp; 内存映射</h3><p>跨进程通信是需要内核空间做支持的。传统的 IPC 机制如管道、Socket 都是内核的一部分。Binder 并不是 Linux 系统内核的一部分，那怎么办呢？这就得益于 Linux 的<strong>动态内核加载模块（Loadable Kernel Module, LKM）</strong>的机制。模块是具有独立功能的程序，它可以被单独编译，但是不能独立运行。<strong>它在运行时被链接到内核作为内核的一部分运行</strong>。这样，Android 系统就可以通过动态添加一个内核模块运行在内核空间，用户进程之间通过这个内核模块作为桥梁来实现通信。</p>
<blockquote>
<p>在 Android 系统中，这个运行在内核空间，负责各个用户进程通过 Binder 实现通信的内核模块就叫 <strong>Binder 驱动（Binder Driver）</strong>。</p>
</blockquote>
<p>如何通过这个内核模块（Binder Driver）来实现通信的呢？—— 内存映射。</p>
<blockquote>
<p>内存机制简单的讲就是将用户空间的一块内存区域映射到内核空间。映射关系建立后，用户对这块内存区域的修改可以直接反映到内核空间，反之内核空间对这段区域的修改也能直接反映到用户空间。</p>
<p>内存映射能减少数据拷贝次数，实现用户空间和内核空间的高效互动，各自空间的修改能被对方及时感知。</p>
</blockquote>
<p>Binder IPC 机制中涉及到的内存映射通过<code>mmap()</code>来实现。</p>
<h3 id="Binder-IPC-实现原理"><a href="#Binder-IPC-实现原理" class="headerlink" title="Binder IPC 实现原理"></a>Binder IPC 实现原理</h3><p><code>mmap()</code>通常是用在有物理介质的文件系统上的。比如进程中互动用户区域是不能直接和物理设备打交道的，如果要把磁盘上的数据读取到进程的用户区域，需要两次拷贝（磁盘-&gt;内核空间-&gt;用户空间）。通常这种场景下<code>mmap()</code>就能发挥作用，通过在物理介质和用户空间之间建立映射，减少数据拷贝次数，用内存读写取代 I/O 读写，提高文件读取效率。</p>
<p>而 Binder 并不存在物理介质，因此 Binder 驱动使用<code>mmap()</code>并不是为了在物理介质和用户空间之间建立映射，而是用来<strong>在内核空间创建数据接收的缓存空间</strong>。</p>
<ol>
<li>首先 Binder 驱动在内核空间创建一个<strong>数据接收缓存区</strong>；</li>
<li>接着在内核空间开辟一块<strong>内核缓存区</strong>，<strong>建立内核缓存区和内核中数据接收缓存区之间的映射关系，以及内核中数据接收缓存区和接收进程用户空间地址的映射关系</strong>；</li>
<li>发送方进程通过系统调用<strong><code>copyfromuser()</code></strong>将数据 copy 到内核中的<strong>内核缓存区</strong>，由于内核缓存区和接收进程的用户空间存在内存映射，因此也就相当于把数据发送到了接收进程的用户空间，这样便完成了一次进程间通信。</li>
</ol>
<p><img src="https://pic4.zhimg.com/80/v2-cbd7d2befbed12d4c8896f236df96dbf_hd.jpg" alt="Binder IPC 通信过程"></p>
<h2 id="Binder-通信模型"><a href="#Binder-通信模型" class="headerlink" title="Binder 通信模型"></a>Binder 通信模型</h2><h3 id="Client-Server-ServiceManager-驱动"><a href="#Client-Server-ServiceManager-驱动" class="headerlink" title="Client/Server/ServiceManager/驱动"></a>Client/Server/ServiceManager/驱动</h3><p><img src="https://pic3.zhimg.com/80/v2-729b3444cd784d882215a24067893d0e_hd.jpg" alt="关系图"></p>
<p>Client、Server、ServiceManager、Binder 驱动这几个组件在通信过程中扮演的角色就如同互联网中的服务器（Server）、客户端（Client）、DNS 域名服务器（ServiceManager）以及路由器（Binder 驱动）之间的关系。</p>
<p>Binder 驱动就如同路由器一样，是整个通信的核心；驱动负责进程之间 Binder 通信的建立，Binder 在进程之间传递，Binder 引用计数管理，数据包在进程之间的传递和交互等一系列底层支持。</p>
<p>ServiceManager 与实名 Binder。ServiceManager 和 DNS 类似作用是<strong>将字符形式的 Binder 名字转化成 Client 中对该 Binder 的引用</strong>。注册了名字的 Binder 叫 实名 Binder，就像网站一样除了有 IP 地址还有自己的域名。</p>
<p>Server 创建了 Binder，并为他起一个字符形式，可读易记的名字，将这个 Binder 实体连同名字一起以数据包的形式通过 Binder 驱动发送给 ServiceManager，通知 ServiceManager 注册一个名为所命名的 Binder，它位于某个 Server 中。驱动为这个穿越进程边界的 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将这个以及新建的引用打包传给 ServiceManager，ServiceManager 收到数据后从中取出名字和引用填入查找表。</p>
<p>ServiceManager 是一个进程，Server 是另外一个进程，Server 向 ServiceManager 中注册 Binder 必然涉及到进程间通信。当前实现进程间通信又要用到进程间通信？！<strong>ServiceManager 和其他进程同样采用 Binder 通信，ServiceManager 是 Server 端，有自己的 Binder 实体，其他进程都是 Client</strong>，需要通过这个 Binder 的引用来实现 Binder 的注册、查询和获取。ServiceManager 提供的 Binder 比较特殊，它没有名字也不需要注册。当一个进程使用 BINDER_SET_CONTEXT_MGR 命令将自己注册成 ServiceManager 时 Binder 驱动会自动为它创建 Binder 实体（这就是那只预先造好的鸡）。<strong>其次这个 Binder 实体的引用在所有 Client 中都固定为 0 而无需通过其他手段获得</strong>。也就是说，一个 Server 想要向 ServiceManager 注册自己的 Binder 就必须通过这个 0 号引用和 ServiceManager 的 Binder 通信。要注意的是，这里说的 Client 是相对于 ServiceManager 而言的，一个进程或者应用程序可能是提供服务的 Server，但对于 ServiceManager 来说它仍然是个 Client</p>
<p>Server 向 ServiceManager 中注册了 Binder 以后，Client 就能通过名字获得 Binder 的引用了。Client 也利用保留的 0 号引用向 ServiceManager 请求访问某个 Binder，ServiceManager 收到请求后从请求数据包中取出 Binder 名称，在查找表中找到对应的条目，取出对应的 Binder 引用作为回复发送回发起请求的 Client。</p>
<h3 id="Binder-通信过程"><a href="#Binder-通信过程" class="headerlink" title="Binder 通信过程"></a>Binder 通信过程</h3><ol>
<li>一个进程使用 BINDERSETCONTEXT_MGR 命令通过 Binder 驱动将自己注册成为 ServiceManager；</li>
<li>Server 通过驱动向 ServiceManager 中注册 Binder （Server 中的 Binder 实体），表明可以对外提供服务。驱动为这个 Binder 创建位于内核中的实体节点以及 ServiceManager 对实体的引用，将名字以及新建的引用打包传给 ServiceManager，ServiceManager 将其填入查找表。</li>
<li>Client 通过名字，在 Binder 驱动的帮助下从 ServiceManager 中获取到对 Binder 实体的引用，通过这个引用就能实现和 Server 进程的通信。</li>
</ol>
<h3 id="Binder-通信中的代理模式"><a href="#Binder-通信中的代理模式" class="headerlink" title="Binder 通信中的代理模式"></a>Binder 通信中的代理模式</h3><p>当 A 进程想要获取 B 进程中的 object 时，驱动并不会真的把 object 返回给 A，而是返回了一个跟 object 看起来一模一样的<strong>代理对象 objectProxy</strong>，这个 objectProxy 具有和 object 一模一样的方法，但是这些方法并没有 B 进程中 object 对象那些方法的能力，这些方法只需要把请求参数交给驱动就可以。对于 A 进程来说和直接调用 object 中的方法是一样的。</p>
<p>当 Binder 驱动接收到 A 进程的消息后，发现这是个 objectProxy 就去查询自己维护的表单，一查发现这是 B 进程 object 的代理对象。于是就会去通知 B 进程调用 object 的方法，并要求 B 进程把返回结果发给自己。当驱动拿到 B 进程的返回结果后就会转发给 A 进程，一次通信就完成了。</p>
<hr>
<h1 id="参考引用"><a href="#参考引用" class="headerlink" title="参考引用"></a>参考引用</h1><p><a href="https://zhuanlan.zhihu.com/p/35519585" target="_blank" rel="noopener">写给 Android 应用工程师的 Binder 原理剖析</a></p>
<p><a href="https://blog.csdn.net/lmj623565791/article/details/38461079" target="_blank" rel="noopener">Android aidl Binder框架浅析</a></p>

  </div>
</article>

	<div class="blog-post-comments">
        
        
        <div class="vcomment"></div>
        
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、概述"><span class="toc-number">1.</span> <span class="toc-text">一、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、AIDL-的使用"><span class="toc-number">2.</span> <span class="toc-text">二、AIDL 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务端"><span class="toc-number">2.1.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端"><span class="toc-number">2.2.</span> <span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析-AIDL-生成的代码"><span class="toc-number">2.3.</span> <span class="toc-text">分析 AIDL 生成的代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Binder-原理剖析"><span class="toc-number">3.</span> <span class="toc-text">Binder 原理剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么必须理解-Binder-？"><span class="toc-number">3.1.</span> <span class="toc-text">为什么必须理解 Binder ？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么是-Binder"><span class="toc-number">3.2.</span> <span class="toc-text">为什么是 Binder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-下传统的进程间通信原理"><span class="toc-number">3.3.</span> <span class="toc-text">Linux 下传统的进程间通信原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binder-跨进程通信原理"><span class="toc-number">3.4.</span> <span class="toc-text">Binder 跨进程通信原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#动态内核可加载模块-amp-amp-内存映射"><span class="toc-number">3.4.1.</span> <span class="toc-text">动态内核可加载模块 &amp;&amp; 内存映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binder-IPC-实现原理"><span class="toc-number">3.4.2.</span> <span class="toc-text">Binder IPC 实现原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binder-通信模型"><span class="toc-number">3.5.</span> <span class="toc-text">Binder 通信模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Client-Server-ServiceManager-驱动"><span class="toc-number">3.5.1.</span> <span class="toc-text">Client/Server/ServiceManager/驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binder-通信过程"><span class="toc-number">3.5.2.</span> <span class="toc-text">Binder 通信过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binder-通信中的代理模式"><span class="toc-number">3.5.3.</span> <span class="toc-text">Binder 通信中的代理模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考引用"><span class="toc-number">4.</span> <span class="toc-text">参考引用</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/26/AIDI-和-Binder/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&text=AIDI 和 Binder"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&is_video=false&description=AIDI 和 Binder"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AIDI 和 Binder&body=Check out this article: http://yoursite.com/2019/03/26/AIDI-和-Binder/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&title=AIDI 和 Binder"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/26/AIDI-和-Binder/&name=AIDI 和 Binder&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 黄耿
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

<!-- Valine Comments -->

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
<script type="text/javascript">
    var notify = 'false' == true ? true : false;
    var verify = 'false' == true ? true : false;
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
      return GUEST_INFO.indexOf(item) > -1
    });
    guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "QkzLlK1k0KOnWTQtGcA7pnfP-gzGzoHsz",
        appKey: "3x2y811wfs2AtVQEz7kKeMhL",
        avatar:"mm",
        placeholder: "say somethings ?",
        guest_info:guest_info,
        pageSize:"10"
    })
</script>
 
</body>
</html>
