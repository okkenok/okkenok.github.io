<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Android 之 BroadcastReceiver静态注册和动态注册默认广播sendBroadcast(intent)和有序广播sendOrderedBroadcast(intent)在注册广播中的  中使用 android:priority 属性（-1000 ~ 1000，数值越大优先级越大）； 动态注册广播不是常驻型广播，跟随 Activity 的生命周期。注意在 Activity 结束前">
<meta name="keywords" content="Android 面试">
<meta property="og:type" content="article">
<meta property="og:title" content="Android之BroadcastReceiver">
<meta property="og:url" content="http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/index.html">
<meta property="og:site_name" content="Okkenok">
<meta property="og:description" content="Android 之 BroadcastReceiver静态注册和动态注册默认广播sendBroadcast(intent)和有序广播sendOrderedBroadcast(intent)在注册广播中的  中使用 android:priority 属性（-1000 ~ 1000，数值越大优先级越大）； 动态注册广播不是常驻型广播，跟随 Activity 的生命周期。注意在 Activity 结束前">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2199790-6ba73aa0df2ffd7c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/844/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2199790-b812439450384c98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/576/format/webp">
<meta property="og:updated_time" content="2019-03-26T14:31:22.203Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android之BroadcastReceiver">
<meta name="twitter:description" content="Android 之 BroadcastReceiver静态注册和动态注册默认广播sendBroadcast(intent)和有序广播sendOrderedBroadcast(intent)在注册广播中的  中使用 android:priority 属性（-1000 ~ 1000，数值越大优先级越大）； 动态注册广播不是常驻型广播，跟随 Activity 的生命周期。注意在 Activity 结束前">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/2199790-6ba73aa0df2ffd7c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/844/format/webp">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Android之BroadcastReceiver</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/21/Android之AsyncTask/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/20/Android之布局优化-1/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&text=Android之BroadcastReceiver"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&is_video=false&description=Android之BroadcastReceiver"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Android之BroadcastReceiver&body=Check out this article: http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&name=Android之BroadcastReceiver&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Android-之-BroadcastReceiver"><span class="toc-number">1.</span> <span class="toc-text">Android 之 BroadcastReceiver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#静态注册和动态注册"><span class="toc-number">1.1.</span> <span class="toc-text">静态注册和动态注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#默认广播sendBroadcast-intent-和有序广播sendOrderedBroadcast-intent"><span class="toc-number">1.2.</span> <span class="toc-text">默认广播sendBroadcast(intent)和有序广播sendOrderedBroadcast(intent)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现原理"><span class="toc-number">1.3.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#底层实现原理"><span class="toc-number">1.4.</span> <span class="toc-text">底层实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#静态广播的注册"><span class="toc-number">1.4.1.</span> <span class="toc-text">静态广播的注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态广播的注册"><span class="toc-number">1.4.2.</span> <span class="toc-text">动态广播的注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发送广播"><span class="toc-number">1.4.3.</span> <span class="toc-text">发送广播</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#粘性广播的实现原理（API21已失效）"><span class="toc-number">1.4.4.</span> <span class="toc-text">粘性广播的实现原理（API21已失效）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#广播队列"><span class="toc-number">1.4.5.</span> <span class="toc-text">广播队列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考引用"><span class="toc-number">1.6.</span> <span class="toc-text">参考引用</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Android之BroadcastReceiver
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Okkenok</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-03-20T14:58:54.000Z" itemprop="datePublished">2019-03-20</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Android-面试/">Android 面试</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Android-之-BroadcastReceiver"><a href="#Android-之-BroadcastReceiver" class="headerlink" title="Android 之 BroadcastReceiver"></a>Android 之 BroadcastReceiver</h1><h2 id="静态注册和动态注册"><a href="#静态注册和动态注册" class="headerlink" title="静态注册和动态注册"></a>静态注册和动态注册</h2><h2 id="默认广播sendBroadcast-intent-和有序广播sendOrderedBroadcast-intent"><a href="#默认广播sendBroadcast-intent-和有序广播sendOrderedBroadcast-intent" class="headerlink" title="默认广播sendBroadcast(intent)和有序广播sendOrderedBroadcast(intent)"></a>默认广播<code>sendBroadcast(intent)</code>和有序广播<code>sendOrderedBroadcast(intent)</code></h2><p>在注册广播中的 <intent-filter> 中使用 android:priority 属性（-1000 ~ 1000，数值越大优先级越大）；</intent-filter></p>
<p>动态注册广播不是常驻型广播，跟随 Activity 的生命周期。注意在 Activity 结束前，移除广播接收器。静态注册是常驻型，当应用关闭后，如有广播来，程序也会被系统调用自动运行；  </p>
<p>当广播为有序广播时，优先级高的先接收（不分动态静态）。同优先级的广播接收器，动态优先于静态。  </p>
<p>同优先级的同类广播接收器，静态：先扫描的优于后扫描的；动态：先注册的优于后注册的。  </p>
<p><strong>对于动态广播，有注册就必然得有注销，否则会导致内存泄漏</strong></p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>Android 中的广播使用了设计模式中的<strong>观察者模式</strong>：基于消息的发布/订阅事件模型。将广播的发送者和接收者极大程度解耦，使得系统能够方便集成，更易扩展。</p>
<ol>
<li>自定义广播接收者 BroadcastReceiver，并重写 <code>onReceiver()</code>方法；</li>
<li>通过 Binder 机制向 AMS (Activity Manager Service) 进行注册；</li>
<li>广播发送者通过 Binder 机制向 AMS 发送广播；</li>
<li>AMS 查找符合相应条件（IntentFilter/Permission 等）的 BroadcastReceiver，将广播发送到 BroadcastReceiver（一般情况下是 Activity）相应的消息循环队列中；</li>
<li>消息循环执行拿到此广播，回调 BroadcastReceiver 中的<code>onReceive()</code>方法</li>
</ol>
<h2 id="底层实现原理"><a href="#底层实现原理" class="headerlink" title="底层实现原理"></a>底层实现原理</h2><h3 id="静态广播的注册"><a href="#静态广播的注册" class="headerlink" title="静态广播的注册"></a>静态广播的注册</h3><p>静态广播是通过 PackageManagerService 在启动的时候扫描已安装的应用去注册的。在其构造方法中，会去扫描应用的安装目录，顺序是先扫描系统应用安装目录在扫描第三方应用。用于扫描的方法<code>PackageManagerService.scanDirLI()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">int</span> flags, <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime)</span></span>&#123;</span><br><span class="line">  String[] files = dir.list();</span><br><span class="line">  <span class="keyword">if</span>(files == <span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;files.length; i++)&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(dir, files[i]);</span><br><span class="line">    <span class="keyword">if</span>(!isPackageFilename(files[i]))&#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PackageParser.Package pkg = scanPackageLI(file, flags|PackageParser.PARSE_MUST_BE_APK, scanMode, currentTime, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span>(pkg == <span class="keyword">null</span> &amp;&amp; (flags &amp; PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &amp;&amp; mLastScanError == PackageManager.INSTALL_FAILED_INVALID_APK)&#123;</span><br><span class="line">      file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isPackageFilename</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> name != <span class="keyword">null</span> &amp;&amp; name.endsWith(<span class="string">".apk"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>scanDirLI()</code>-&gt;<code>scanPackageLI()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime, UserHandle user)</span></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">final</span> PackageParser.Package pkg = pp.parsePackage(scanFile, scanPath, mMetrics, parseFlags);</span><br><span class="line">  ...</span><br><span class="line">  PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanMode | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>scanDirLI()</code>-&gt;<code>scanPackageLI()</code>-&gt;重载的<code>scanPackageLI()</code><br>在这个<code>scanPackageLI()</code>里面会解析 Package 并且将 AndroidManifest.xml 中注册的 BroadcastReceiver 保存下来<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">N = pkg.reveivers.size();</span><br><span class="line">r = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;N; i++)&#123;</span><br><span class="line">  PackageParser.Activity a = pkg.reveivers.get(i);</span><br><span class="line">  a.info.processName = fixProcessName(pkg.applicationInfo.processName, a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">  mReceivers.addActivity(a, <span class="string">"receiver"</span>);<span class="comment">// 注册静态广播到了 PackageManagerService 的 mReceivers</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可用<code>PackageManagerService.queryIntentReceivers()</code>查询 intent 对应的静态广播。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntentReceivers</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span></span>&#123;</span><br><span class="line">  <span class="comment">// ResolveInfo 解析 Intent 过程中返回的信息，实际上就是 AndroidManifest.xml 标签的信息</span></span><br><span class="line">  <span class="keyword">if</span>(!sUserManager.exists(userId)) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">  ComponentName comp = intent.getComponent();</span><br><span class="line">  <span class="keyword">if</span>(comp == <span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(intent.getSelector() != <span class="keyword">null</span>)&#123;</span><br><span class="line">      intent = intent.getSelector();</span><br><span class="line">      comp = intent.getComponent();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(comp != <span class="keyword">null</span>)&#123;</span><br><span class="line">    List&lt;ResolveInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResolveInfo&gt;(<span class="number">1</span>);</span><br><span class="line">    ActivityInfo ai = getReceiverInfo(comp, flags, userId);</span><br><span class="line">    <span class="keyword">if</span>(ai != <span class="keyword">null</span>)&#123;</span><br><span class="line">      ResolveInfo ri = <span class="keyword">new</span> ResolveInfo();</span><br><span class="line">      ri.activityInfo = ai;</span><br><span class="line">      list.add(ri);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (mPackages)&#123;</span><br><span class="line">    <span class="comment">// 这个的作用是？</span></span><br><span class="line">    String pkgName = intent.getPackage();</span><br><span class="line">    <span class="keyword">if</span>(pkgName == <span class="keyword">null</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> mReceivers.queryIntent(intent, resolvedType, flags, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(pkgName);</span><br><span class="line">    <span class="keyword">if</span>(pkg != <span class="keyword">null</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> mReceivers.queryIntentForPackage(intent, resolvedType, flags, pkg.receivers, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="动态广播的注册"><a href="#动态广播的注册" class="headerlink" title="动态广播的注册"></a>动态广播的注册</h3><p>我们调用<code>Context.registerReceiver()</code>最后都会调到<code>ActivityManagerService.registerReceiver()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(IApplicationThread caller, String callerPackage, IIntentReceiver receiver, IntentFilter filter, String permission, <span class="keyword">int</span> userId)</span></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ReceiverList rl = (ReceiverList)mRegisteredReceivers.get(receiver.asBinder());</span><br><span class="line">  ...</span><br><span class="line">  BroadcastFilter bf = <span class="keyword">new</span> BroadcastFilter(filter, rl, callerPackage, permission, callingUid, userId);</span><br><span class="line">  ...</span><br><span class="line">  mReceiverResolver.addFilter(bf);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以通过<code>mReceiverResolver.queryIntent()</code>就能获得 intent 对应的动态广播了。</p>
<h3 id="发送广播"><a href="#发送广播" class="headerlink" title="发送广播"></a>发送广播</h3><p><code>ContextImpl.sendBroadcast()</code>中会调用<code>ActivityManagerNative.getDefault().broadcastIntent()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBroadcast</span><span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">  warnIfCallingFromSystemProcess();</span><br><span class="line">  String resolvedType = intent.resolvedTypeIfNeeded(getContentResolver());</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    intent.prepareToLeaveProcess();</span><br><span class="line">    ActivityManagerNative.getDefault().broadcastIntent(mMainThread.getApplicationThread(), intent, resolvedType, <span class="keyword">null</span>, Activity.RESULT_OK, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE, <span class="keyword">false</span>, <span class="keyword">false</span>, getUserId());</span><br><span class="line">  &#125;<span class="keyword">catch</span>(RemoteException e)&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际上调用<code>ActivityManagerService.broadcastIntent()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">broadcastIntent</span><span class="params">(IApplicationThread caller, Intent intent, String resolvedType, IIntentReceiver resultTo, <span class="keyword">int</span> resultCode, String resultData, Bundle map, String requiredPermission, <span class="keyword">int</span> appOp, <span class="keyword">boolean</span> serialized, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> userId)</span></span>&#123;</span><br><span class="line">  enforceNotIsolatedCaller(<span class="string">"broadcastIntent"</span>);</span><br><span class="line">  <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">    intent = verifyBroadcastLocked(intent);</span><br><span class="line">    <span class="keyword">final</span> ProcessRecord callerApp = getRecordForAppLocked(caller);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">int</span> res = broadcastIntentLocked(callerApp, callerApp != <span class="keyword">null</span> ? callerApp.info.packageName : <span class="keyword">null</span>, intent, resolvedType, resultTo, resultCode, resultData, map, requiredPermission, appOp, serialized, sticky, callingPid, callingUid, userId);</span><br><span class="line">    Binder.restoreCallingIdentity(origId);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>ActivityManagerService.broadcastIntent()</code>中又会调用<code>ActivityManagerService.broadcastIntentLocked()</code>,其中关键代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//静态广播</span></span><br><span class="line">List receivers = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//动态广播</span></span><br><span class="line">List&lt;BroadcastFilter&gt; registeredReceivers = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>((intent.getFlags() &amp; Intent.FLAG_RECEIVER_REGISTERED_ONLY) == <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="comment">//查询静态广播</span></span><br><span class="line">  receivers = collectReceiverComponents(intent, resolvedType, users);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(intent.getComponent() == <span class="keyword">null</span>)&#123;</span><br><span class="line">  <span class="comment">//查询动态广播</span></span><br><span class="line">  registeredReceivers = mReceiverResolver.queryIntent(intent, resolvedType, <span class="keyword">false</span>, userId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> replacePending = (intent.getFlags() &amp; Intent.FLAG_RECEIVER_REPLACE_PENDING) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> NR = registeredReceivers != <span class="keyword">null</span> ? registeredReceivers.size() : <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!ordered &amp;&amp; NR &gt; <span class="number">0</span>) &#123;</span><br><span class="line">   <span class="keyword">final</span> BroadcastQueue queue = broadcastQueueForIntent(intent);</span><br><span class="line">   BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, callerApp,</span><br><span class="line">           callerPackage, callingPid, callingUid, resolvedType, requiredPermission,</span><br><span class="line">           appOp, registeredReceivers, resultTo, resultCode, resultData, map,</span><br><span class="line">           ordered, sticky, <span class="keyword">false</span>, userId);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> replaced = replacePending &amp;&amp; queue.replaceParallelBroadcastLocked(r);</span><br><span class="line">   <span class="keyword">if</span> (!replaced) &#123;</span><br><span class="line">       <span class="comment">// 发送动态广播</span></span><br><span class="line">       queue.enqueueParallelBroadcastLocked(r);</span><br><span class="line">       queue.scheduleBroadcastsLocked();</span><br><span class="line">   &#125;</span><br><span class="line">   registeredReceivers = <span class="keyword">null</span>;</span><br><span class="line">   NR = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ((receivers != <span class="keyword">null</span> &amp;&amp; receivers.size() &gt; <span class="number">0</span>)</span><br><span class="line">    || resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">   BroadcastQueue queue = broadcastQueueForIntent(intent);</span><br><span class="line">   BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, callerApp,</span><br><span class="line">           callerPackage, callingPid, callingUid, resolvedType,</span><br><span class="line">           requiredPermission, appOp, receivers, resultTo, resultCode,</span><br><span class="line">           resultData, map, ordered, sticky, <span class="keyword">false</span>, userId);</span><br><span class="line">   <span class="keyword">boolean</span> replaced = replacePending &amp;&amp; queue.replaceOrderedBroadcastLocked(r);</span><br><span class="line">   <span class="keyword">if</span> (!replaced) &#123;</span><br><span class="line">       <span class="comment">// 发送静态广播</span></span><br><span class="line">       queue.enqueueOrderedBroadcastLocked(r);</span><br><span class="line">       queue.scheduleBroadcastsLocked();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>动态广播会优于静态广播，从上面的代码可以看到，这实际是因为 Android 的源代码就是按照这个顺序写的。</p>
<p><code>ActivityManagerService.collectReceiverComponents()</code>，实际上静态广播就是从 PackageManagerService 中查询的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;ResolveInfo&gt; <span class="title">collectReceiverComponents</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span>[] users)</span></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  List&lt;ResolveInfo&gt; newReceivers = AppGlobals.getPackageManager().queryIntentReceivers(intent, resolvedType, STOCK_PM_FLAGS, user);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="粘性广播的实现原理（API21已失效）"><a href="#粘性广播的实现原理（API21已失效）" class="headerlink" title="粘性广播的实现原理（API21已失效）"></a>粘性广播的实现原理（API21已失效）</h3><p><code>ActivityManagerService.broadcastIntentLocked()</code>有下面这样一段代码，它将粘性广播存到了 mStickyBroadcasts 中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(sticky)&#123;</span><br><span class="line">  ...</span><br><span class="line">  ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt; stickies = mStickyBroadcasts.get(userId);</span><br><span class="line">  <span class="keyword">if</span>(stickies == <span class="keyword">null</span>)&#123;</span><br><span class="line">    stickies = <span class="keyword">new</span> ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt;();</span><br><span class="line">    mStickyBroadcasts.put(userId, stickies);</span><br><span class="line">  &#125;</span><br><span class="line">  ArrayList&lt;Intent&gt; list = stickies.get(intent.getAction());</span><br><span class="line">  <span class="keyword">if</span>(list == <span class="keyword">null</span>)&#123;</span><br><span class="line">    list = <span class="keyword">new</span> ArrayList&lt;Intent&gt;();</span><br><span class="line">    stickies.put(intent.getAction(), list);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> N = list.size();</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(intent.filterEquals(list.get(i)))&#123;</span><br><span class="line">      <span class="comment">// This sticky already exists, replace it.</span></span><br><span class="line">      list.set(i, <span class="keyword">new</span> Intent(intent));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(i &gt;= N)&#123;</span><br><span class="line">    list.add(<span class="keyword">new</span> Intent(intent));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而 ManagerService.registerReceiver 会获取之前发送的粘性广播，再次发送给刚刚注册的 receiver：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">List allSticky = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取符合的粘性广播</span></span><br><span class="line">Iterator actions = filter.actionsIterator();</span><br><span class="line"><span class="keyword">if</span>(actions != <span class="keyword">null</span>)&#123;</span><br><span class="line">  <span class="keyword">while</span>(actions.hasNext())&#123;</span><br><span class="line">    String action = (String)actions.next();</span><br><span class="line">    allSticky = getStickiesLocked(action, filter, allSticky, UserHandle.USER_ALL);</span><br><span class="line">    allSticky = getStickiesLocked(action, filter, allSticky, UserHandle.getUserId</span><br><span class="line">    (callingUid));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  allSticky = getStickiesLocked(<span class="keyword">null</span>, filter, allSticky, UserHandle.USER_ALL);</span><br><span class="line">  allSticky = getStickiesLocked(<span class="keyword">null</span>, filter, allSticky, UserHandle.getUserId(callingUid));</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//向新注册的 receiver 发送粘性广播</span></span><br><span class="line"><span class="keyword">if</span>(allSticky != <span class="keyword">null</span>)&#123;</span><br><span class="line">  ArrayList receivers = <span class="keyword">new</span> ArrayList();</span><br><span class="line">  receivers.add(bf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> N = allSticky.size();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">    Intent intent = (Intent)allSticky.get(i);</span><br><span class="line">    BroadcastQueue queue = broadcastQueueForIntent(intent);</span><br><span class="line">    BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE, reveivers, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, -<span class="number">1</span>);</span><br><span class="line">    queue.enqueueParallelBroadcastLocked(r);</span><br><span class="line">    queue.scheduleBroadcastsLocked();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><code>getStickiesLocked()</code>即从 mStickyBroadcasts 中查询之前发送过的粘性广播<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> List <span class="title">getStickiesLocked</span><span class="params">(String action, IntentFilter filter, List cur, <span class="keyword">int</span> userId)</span></span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ContentResolver resolver = mContext.getContentResolver();</span><br><span class="line">  ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt; stickies = mStickyBroadcasts.get(userId);</span><br><span class="line">  <span class="keyword">if</span>(stickies == <span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> cur;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> ArrayList&lt;Intent&gt; list = stickies.get(action);</span><br><span class="line">  <span class="keyword">if</span>(list == <span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> cur;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> N = list.size();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">    Intent intent = list.get(i);</span><br><span class="line">    <span class="keyword">if</span>(filter.match(resolver, intent, <span class="keyword">true</span>, TAG) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(cur == <span class="keyword">null</span>)&#123;</span><br><span class="line">        cur = <span class="keyword">new</span> ArrayList&lt;Intent&gt;();</span><br><span class="line">      &#125;</span><br><span class="line">      cur.add(intent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="广播队列"><a href="#广播队列" class="headerlink" title="广播队列"></a>广播队列</h3><p>从<code>ActivityManagerService.broadcastIntentLocked()</code>可以看到，实际上它不是直接将广播发送到 BroadcastReceiver 中的，而是将它包装到 BroadcastRecord 中，再放进 BroadcastQueue:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BroadcastQueue queue = broadcastQueueForIntent(intent);</span><br><span class="line">BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE, receivers, <span class="keyword">null</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, -<span class="number">1</span>);</span><br><span class="line">queue.enqueueParallelBroadcastLocked(r);</span><br><span class="line">queue.scheduleBroadcastsLocked();</span><br></pre></td></tr></table></figure></p>
<p><code>enqueueParallelBroadcastLocked()</code>方法用于并发执行广播的发送：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueParallelBroadcastLocked</span><span class="params">(BroadcastRecord r)</span></span>&#123;</span><br><span class="line">  mParallelBroadcasts.add(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>scheduleBroadcastsLocked()</code>就是向 mHandler 发送了个 BROADCAST_INTENT_MSG 消息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleBroadcastsLocked</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(mBroadcastsScheduled)&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, <span class="keyword">this</span>));</span><br><span class="line">  mBroadcastsScheduled = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mHandler 的工作：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Handler mHandler = <span class="keyword">new</span> Handler()&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">case</span> BROADCAST_INTENT_MSG:&#123;</span><br><span class="line">      processNextBroadcast(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BROADCAST_TIMEOUT_MSG:&#123;</span><br><span class="line">      broadcastTimeoutLocked(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>processNextBroadcast()</code>用于从队列中获取广播消息并发给 BroadcastReceiver，它内部有两个分支，并行处理和串行处理：  </p>
<p>并行处理：例如动态注册的非有序广播等就是使用并行处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processNextBroadcast</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span></span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (mService)&#123;</span><br><span class="line">    BroadcastRecord r;</span><br><span class="line">    mService.updateCpuStats();</span><br><span class="line">    <span class="keyword">if</span>(fromMsg)&#123;</span><br><span class="line">      mBroadcastsScheduled = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(mParallelBroadcasts.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      r = mParallelBroadcasts.remove(<span class="number">0</span>);</span><br><span class="line">      r.dispatchTime = SystemClock.currentTimeMills();</span><br><span class="line">      <span class="keyword">final</span> N = r.receivers.size();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        Object target = r.reveivers.get(i);</span><br><span class="line">        <span class="comment">//发送消息给 Receiver</span></span><br><span class="line">        deliverToRegisteredReceiverLocked(r, (BroadcastFilter)target, <span class="keyword">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      addBroadcastToHistoryLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">deliverToRegisteredReceiverLocked</span><span class="params">(BroadcastRecord r, BroadcastFilter filter, <span class="keyword">boolean</span> ordered)</span></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//获取 BroadcastReceiver 的 Binder</span></span><br><span class="line">  r.receiver = filter.receiverList.receiver.asBinder();</span><br><span class="line">  ...</span><br><span class="line">  performReceiveLocked(filter.receiverList.app, filter.receiverList.receiver, <span class="keyword">new</span> Intent(r.intent), r.resultCode, r.resultData, r.resultExtras, r.ordered, r.initialSticky, r.userId);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performReceiveLocked</span><span class="params">(ProcessRecord app, IIntentReceiver receiver, Intent intent, <span class="keyword">int</span> resultCode, String data, Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//通过 Binder 将消息处理传到应用进程，应用进程内部再通过 Handler 机制，将消息放到主线程中</span></span><br><span class="line">  app.thread.scheduleRegisteredReceiver(receiver, intent, resultCode, data, extras, ordered, sticky, sendingUser, app.repProcState);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>串行处理：例如有序广播和静态广播，会通过<code>enqueueOrderedBroadcastLocked()</code>传给 BroadcastQueue:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueOrderedBroadcastLocked</span><span class="params">(BroadcastRecord r)</span></span>&#123;</span><br><span class="line">  mOrderedBroadcasts.add(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在<code>processNextBroadcast()</code>里面会对 mOrderedBroadcasts 进行特殊处理…<br>(我也看不懂啊~)</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>广播队列传送广播给 Receiver 的原理其实就是将 BroadcastReceiver 和消息都放到 BroadcastRecord 里面，然后通过 Handler 机制遍历 BroadcastQueue 里面的 BroadcastRecord，将消息发送给 BroadcastReceiver。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2199790-6ba73aa0df2ffd7c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/844/format/webp" alt="流程"></p>
<p>整个广播机制可以总结成下面这张图：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2199790-b812439450384c98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/576/format/webp" alt="广播机制流程"></p>
<hr>
<h2 id="参考引用"><a href="#参考引用" class="headerlink" title="参考引用"></a>参考引用</h2><p><a href="https://blog.csdn.net/csdn_aiyang/article/details/68947014" target="_blank" rel="noopener">Android 广播Broadcast的两种注册方式静态和动态</a><br>特别感谢 <a href="https://www.jianshu.com/p/02085150339c" target="_blank" rel="noopener">安卓广播的底层实现原理</a>，其实很多都是照着打，还得慢慢看</p>

  </div>
</article>

	<div class="blog-post-comments">
        
        
        <div class="vcomment"></div>
        
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Android-之-BroadcastReceiver"><span class="toc-number">1.</span> <span class="toc-text">Android 之 BroadcastReceiver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#静态注册和动态注册"><span class="toc-number">1.1.</span> <span class="toc-text">静态注册和动态注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#默认广播sendBroadcast-intent-和有序广播sendOrderedBroadcast-intent"><span class="toc-number">1.2.</span> <span class="toc-text">默认广播sendBroadcast(intent)和有序广播sendOrderedBroadcast(intent)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现原理"><span class="toc-number">1.3.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#底层实现原理"><span class="toc-number">1.4.</span> <span class="toc-text">底层实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#静态广播的注册"><span class="toc-number">1.4.1.</span> <span class="toc-text">静态广播的注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态广播的注册"><span class="toc-number">1.4.2.</span> <span class="toc-text">动态广播的注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发送广播"><span class="toc-number">1.4.3.</span> <span class="toc-text">发送广播</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#粘性广播的实现原理（API21已失效）"><span class="toc-number">1.4.4.</span> <span class="toc-text">粘性广播的实现原理（API21已失效）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#广播队列"><span class="toc-number">1.4.5.</span> <span class="toc-text">广播队列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考引用"><span class="toc-number">1.6.</span> <span class="toc-text">参考引用</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&text=Android之BroadcastReceiver"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&is_video=false&description=Android之BroadcastReceiver"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Android之BroadcastReceiver&body=Check out this article: http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&title=Android之BroadcastReceiver"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/20/Android之BroadcastReceiver-1/&name=Android之BroadcastReceiver&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 黄耿
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

<!-- Valine Comments -->

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
<script type="text/javascript">
    var notify = 'false' == true ? true : false;
    var verify = 'false' == true ? true : false;
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
      return GUEST_INFO.indexOf(item) > -1
    });
    guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "QkzLlK1k0KOnWTQtGcA7pnfP-gzGzoHsz",
        appKey: "3x2y811wfs2AtVQEz7kKeMhL",
        avatar:"mm",
        placeholder: "say somethings ?",
        guest_info:guest_info,
        pageSize:"10"
    })
</script>
 
</body>
</html>
